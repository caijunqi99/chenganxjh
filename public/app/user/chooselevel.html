<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8" />
    <title>想见孩-选择套餐</title>
    <meta name="author" content="想见孩" />
    <meta name="copyright" content="想见孩" />
    <meta name="description" content="想见孩" />
    <meta id="viewport" name="viewport" content="width=750" />
    <link rel="stylesheet" href="../content/style/reset.css" type="text/css" />
    <link rel="stylesheet" href="../content/plugins/iconfonts/iconfont.css" type="text/css" />
    <link rel="stylesheet" href="../content/plugins/jqweui/lib/weui.min.css" type="text/css" />
    <link rel="stylesheet" href="../content/plugins/jqweui/css/jquery-weui.min.css" type="text/css" />
    <link rel="stylesheet" href="../content/style/common.css" type="text/css" />
    <link rel="stylesheet" href="../content/style/user.css" type="text/css" />
    <link rel="shortcut icon" href="../content/images/ico.ico" type="image/x-icon" />
    <script src="../content/scripts/mobile-util.js"></script>
    <link rel="stylesheet" href="/static/plugins/layer/css/layui.css">      
</head>

<body>
    <header class="head">
        <div class="head0">
            <div class="menu_bar_box">
                <a href="javascript:;" class="back_btn" onClick="historyback();">
                    <i class="icon iconfont icon-jiantou3"></i>
                </a>
            </div>
            <div class="head_title">
                <p>选择套餐</p>
            </div>
            <div class="head_r">

            </div>
        </div>
    </header>

    <!-- 主要内容 -->
    <div class="main paddb120">
        <div class="cont margt50">
            <div class="container3">
                <ul class="level_list clearfix">
<!--                     <li class="active">
                        <div class="level_item">
                            <span class="level_hot">热门推荐</span>
                            <p class="level_item_p1">12个月</p>
                            <p class="level_item_p2">￥<strong>360</strong></p>
                            <p class="level_item_p3">￥360</p>
                            <p class="level_item_p4"><span>每天不到一块钱</span></p>
                        </div>
                    </li>
                    <li>
                        <div class="level_item">
                            <p class="level_item_p1">3个月</p>
                            <p class="level_item_p2">￥<strong>180</strong></p>
                            <p class="level_item_p3">￥300</p>
                        </div>
                    </li>
                    <li>
                        <div class="level_item">
                            <p class="level_item_p1">1个月</p>
                            <p class="level_item_p2">￥<strong>60</strong></p>
                            <p class="level_item_p3">￥100</p>
                        </div>
                    </li> -->
                    <li data-info='{"pkg_id":11,"pkg_name":"按月收费","pkg_sort":4,"pkg_enabled":1,"pkg_cprice":"0.00","pkg_price":"100.00","pkg_type":2,"pkg_length":1,"pkg_axis":"mouth","pkg_desc":"按月收费","up_time":null,"pkg_title":"1个月"}'><div class="level_item"><p class="level_item_p1">1个月</p><p class="level_item_p2">￥<strong>100.00</strong></p><p class="level_item_p3">￥0.00</p></div></li>
                    <li class="active" data-info='{"pkg_id":8,"pkg_name":"一年套餐","pkg_sort":666,"pkg_enabled":1,"pkg_cprice":"0.00","pkg_price":"365.00","pkg_type":2,"pkg_length":1,"pkg_axis":"year","pkg_desc":"每天不到一块钱","up_time":"1537949293","pkg_title":"12个月"}'><div class="level_item"><span class="level_hot">热门推荐</span><p class="level_item_p1">12个月</p><p class="level_item_p2">￥<strong>365.00</strong></p><p class="level_item_p3">￥0.00</p><p class="level_item_p4"><span>每天不到一块钱</span></p></div></li>
                </ul>
            </div>

            <div class="choosed_box">
                <div class="container2">
                    <p class="choosed_info">
                        <i class="icon iconfont icon-tixingtishi"></i> 您选择的套餐将在<span class="date">2019-09-11</span>到期
                    </p>
                </div>
            </div>

            <div class="payment_mode_box">
                <div class="container2">
                    <div class="weui-cells weui-cells_checkbox clearfix" id="payments">
                        <label class="weui-cell weui-check__label" for="s11" style="visibility: hidden;" id="wxpay_h5">
                            <div class="weui-cell__bd">
                                <p><img class="zhifulogo" src="../content/images/icons/weixin.png" alt="">
                                    微信支付
                                </p>
                            </div>
                            <div class="weui-cell__hd">
                                <input type="radio" class="weui-check" name="payment_code" id="s11" value="wxpay_h5">
                                <i class="weui-icon-checked"></i>
                            </div>
                        </label>
                        <label class="weui-cell weui-check__label" for="s12" style="visibility: hidden;" id="alipay_app">
                            <div class="weui-cell__bd">
                                <p><img class="zhifulogo" src="../content/images/icons/zhifubao.png" alt="" >
                                    支付宝支付
                                </p>
                            </div>
                            <div class="weui-cell__hd">
                                <input type="radio" name="payment_code" class="weui-check" id="s12" value="alipay_app">
                                <i class="weui-icon-checked"></i>
                                </div>
                        </label>
                        <label class="weui-cell weui-check__label" for="s11" style="visibility: hidden;" id="nopay">
                            <div class="weui-cell__bd">
                                <p><img class="zhifulogo" src="../content/images/icons/weixin.png" alt=""></p>
                            </div>
                            <div class="weui-cell__hd">
                                <i class="weui-icon-checked"></i>
                            </div>
                        </label>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <div class="total_box">
        <div class="total_cont">
            <div class="total_cont_l">
                <dl class="total_info">
                    <dt>总计：￥<strong id="price">0</strong> <span id="Discount">已优惠0元</span></dt>
                    <dd id="pkgdesc"></dd>
                </dl>
            </div>
            <div class="total_cont_r">
                <a class="total_cont_btn" href="javascript:;">确认支付</a>
            </div>
        </div>

    </div>

    <script src="../content/scripts/jquery.min.js"></script>
    <script src="../content/plugins/jqweui/js/jquery-weui.min.js"></script>
    <script src="../content/plugins/jqweui/js/city-picker.min.js"></script>
    <script src="/static/plugins/layer/layui.all.js"></script>
    <script src="/static/plugins/layer/layui.js"></script>
    <script src="/static/plugins/layer/layer.js"></script>
    <script src="../content/scripts/juqery.cookie.js"></script>
    <script src="../content/scripts/commom.js"></script>
    <script src="../content/scripts/API.js"></script>

    <script>
        $(function() {
            // api = 'http://w.xjh.com/index.php/Wap';
            var pkg_type = GetQueryString('pkg_type');
            var child_id = GetQueryString('child_id');
            if (pkg_type && child_id) {
                GetPackagesList(pkg_type)
                GetPaymentList();
            }else{
                $.alert('参数错误,获取不到学生信息或套餐信息！','系统提示',function(){
                    historyback();
                })
            }
            // 选择套餐
            $(".level_list>li").click(function() {
                $(this).siblings().removeClass("active").end().addClass("active");
                var pkginfo = $(this).attr('data-info');

                $.post(api+'/Packagesbuy/packages_time_reckon', {'key': user_token,'child_id':child_id,'pkginfo': pkginfo}, function(data, textStatus, xhr) {
                    if (data.code == 200) {
                        $('.date').text(data.result[0].end_time)
                        pkginfo =$.parseJSON(pkginfo);
                        $('#price').text(pkginfo.pkg_price)
                        var Discount = pkginfo.pkg_cprice - pkginfo.pkg_price;
                        $('#Discount').text('已优惠'+Discount+'元')
                        var type = pkginfo.pkg_type == 1 ?'看孩':'回放';
                        var name = $('.active .level_item_p1').text();
                        $('#pkgdesc').text('您已选择'+type+name+'套餐')
                    }else{
                        $('.choosed_info').html(data.msg);
                    }
                },"json");
            })

            $('.total_cont_btn').click(function(event) {
                var pay = $("input[name='payment_code']:checked").val();
                if (pay=='undefined' || !pay || pay == '') {
                    $.alert('没有选择支付方式','系统提示');return false;
                }
                var pkginfo = $('.active').attr('data-info');
                    pkginfo =$.parseJSON(pkginfo);
                var pkgid = pkginfo.pkg_id;
                if(!pkgid){
                    $.alert('请选择套餐！','系统提示');return false;
                }
                if (!child_id) {
                    $.alert('参数错误! child','系统提示');return false;   
                }
                $.post(api+'/Packagesbuy/buy_step1',
                {
                    'key': user_token,
                    'pkg_id': pkgid,
                    'payment_code': pay,
                    'chind_id': child_id,
                }, function(data, textStatus, xhr) {
                    // alert(data);
                    if (pay == 'alipay_app') {
                        layer.open({
                          type: 1,
                          title: '课程管理',
                          shadeClose: true,
                          shade: false,
                          maxmin: false, //开启最大化最小化按钮
                          // area: ['400px', '300px'],
                          content: data
                        });
                        return ;
                    }
                    if(pay=='wxpay_h5'){
                        data =$.parseJSON(data);
                        var mbs = data.result;

                        if (mbs.result_code== 'SUCCESS') {
                            window.location.href=mbs.mweb_url;return ;
                        }
                    }
                });
            });

            
            function GetPackagesList(pkg_type) {
                $.ajax({
                    url: api+'/Packagesbuy/get_packages_list',
                    type: 'POST',
                    dataType: 'json',
                    data: {'key':user_token,'pkg_type': pkg_type},
                })
                .done(function(sb) {
                    if (sb.code==200) {
                        package = sb.result;
                        var pkghtml='';
                        for (var i = 0; i < package.length; i++) {
                                var packinfo = JSON.stringify(package[i]);
                                packinfo = packinfo.replace(' ','');
                                if (package[i].pkg_sort==666) {
                                    pkghtml+='<li class="active" data-info="'+packinfo+'">';
                                }else{
                                    pkghtml+='<li data-info="'+packinfo+'">';
                                }
                                    pkghtml+=   '<div class="level_item">';
                                if (package[i].pkg_sort==666) {
                                    pkghtml+=       '<span class="level_hot">热门推荐</span>';
                                }
                                    pkghtml+=       '<p class="level_item_p1">'+package[i].pkg_title+'</p>'+
                                                    '<p class="level_item_p2">￥<strong>'+package[i].pkg_price+'</strong></p>'+
                                                    '<p class="level_item_p3">￥'+package[i].pkg_cprice+'</p>';
                                if (package[i].pkg_sort==666) {
                                    pkghtml+=        '<p class="level_item_p4"><span>'+package[i].pkg_desc+'</span></p>';    
                                }
                                pkghtml+=       '</div>'+
                                            '</li>';
                        }
                        // $('.level_list').html(pkghtml);
                    }else{
                        $.alert(sb.message,'系统提示',function(){
                            historyback();
                        })
                    }
                    
                })
            }

            function GetPaymentList(){
                $.post(api+'/Packagesbuy/get_payment_list', {'key':user_token}, function(data, textStatus, xhr) {
                    if (data.code == 200) {
                        var payment = data.result[0];
                        console.log()
                        if(payment.length > 0){
                            for (var i = 0; i < payment.length; i++) {
                                $('#'+payment[i].payment_title).css('visibility','visible');
                            }
                        }else{
                            $('#nopay').css('visibility','visible');
                        }
                        
                    }
                },'json');
            }
        })

        // $.alert(window.location.href,'URL',function(){
            
        // })

  // $.alert("AlphaGo 就是天网的前身，人类要完蛋了！", "警告！",function(){
  //       alert("看来真的药丸");
  // });

    </script>
</body>

</html>